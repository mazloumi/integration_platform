<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integration Configuration</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="demo-header">
        <h1>Integration</h1>
        <p>Source â†’ Condition â†’ Transform â†’ Target</p>
    </div>

    <div class="demo-examples">
        <div class="example-section">
            <h3>ðŸ“š Quick Start Examples</h3>
            <button class="example-btn" id="example1-btn">Webhook â†’ User API</button>
            <button class="example-btn" id="example2-btn">PubSub â†’ Order API</button>
            <button class="example-btn" id="example3-btn">Webhook â†’ Email</button>
        </div>
    </div>

    <div id="mapper-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="mapper.js"></script>
    <script>

    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const parameterName = 'integration_id'; // Replace with the name of your parameter
    if (urlParams.has(parameterName)) {
           // Initialize
        mapperInstance = new JSONMapper({
        container: '#mapper-container',
        integrationId: urlParams.get(parameterName),
        onSave: function(config) {
            console.log('Configuration saved!');
            console.log(config);
        }
    });
    } else {
          // Initialize
        mapperInstance = new JSONMapper({
        container: '#mapper-container',
        onSave: function(config) {
            console.log('Configuration saved!');
            console.log(config);
      }
    });
    }    

    // Example functions
    function loadIntegrationExample1() {
      document.getElementById('integration-name').value = 'Webhook to Webhook';
      document.getElementById('source-type').value = 'webhook';
      mapperInstance.updateSourceConfig('webhook');
      mapperInstance.generateWebhook();
      
      document.getElementById('integration-method').value = 'POST';
      document.getElementById('integration-url').value = 'https://webhook.site/<someid>';
      document.getElementById('integration-auth').value = 'none';
      
      mapperInstance.saveIntegration();

      const source = JSON.stringify({
        "event": "user.created",
        "data": {
          "firstName": "John",
          "lastName": "Doe",
          "email": "john.doe@example.com",
          "age": 30
        }
      }, null, 2);

      const target = JSON.stringify({
        "name": "",
        "email": "",
        "username": ""
      }, null, 2);

      mapperInstance.loadJsonStrings(source, target);
      
      setTimeout(function() {
        mapperInstance.addMapping('', 'name', 'javascript', [], 
          "return fields['data.firstName'] + ' ' + fields['data.lastName']", 
          ['data.firstName', 'data.lastName']);
        mapperInstance.addMapping('data.email', 'email', 'lowercase');
        mapperInstance.addMapping('', 'username', 'javascript', [], 
          "return fields['data.firstName'].toLowerCase() + '_' + fields['data.lastName'].toLowerCase()", 
          ['data.firstName', 'data.lastName']);
      }, 200);
    }

    function loadIntegrationExample2() {
      document.getElementById('integration-name').value = 'Order PubSub to API';
      document.getElementById('source-type').value = 'pubsub';
      mapperInstance.updateSourceConfig('pubsub');
      
      document.getElementById('pubsub-project').value = 'my-project-id';
      document.getElementById('pubsub-subscription').value = 'orders-subscription';
      
      document.getElementById('integration-method').value = 'POST';
      document.getElementById('integration-url').value = 'https://api.example.com/orders';
      document.getElementById('integration-auth').value = 'bearer';
      mapperInstance.updateIntegrationAuthConfig('bearer');
      
      setTimeout(function() {
        document.getElementById('integration-bearer-token').value = 'demo-token-12345';
        mapperInstance.saveIntegration();

        const source = JSON.stringify({
          "orderId": "ORD-12345",
          "customer": {
            "name": "Jane Smith",
            "email": "jane@example.com"
          },
          "items": [
            {"id": 1, "name": "Product A"},
            {"id": 2, "name": "Product B"}
          ],
          "total": 99.99
        }, null, 2);

        const target = JSON.stringify({
          "order_id": "",
          "customer_name": "",
          "customer_email": "",
          "item_count": "",
          "total_amount": ""
        }, null, 2);

        mapperInstance.loadJsonStrings(source, target);
        
        setTimeout(function() {
          mapperInstance.addMapping('orderId', 'order_id', 'none');
          mapperInstance.addMapping('customer.name', 'customer_name', 'uppercase');
          mapperInstance.addMapping('customer.email', 'customer_email', 'lowercase');
          mapperInstance.addMapping('', 'item_count', 'javascript', [], 
            "return fields['items'].length", 
            ['items']);
          mapperInstance.addMapping('', 'total_amount', 'javascript', [], 
            "return ' + fields['total'].toFixed(2)", 
            ['total']);
        }, 200);
      }, 100);
    }

    function loadIntegrationExample3() {
      document.getElementById('integration-name').value = 'Email Integration test';
      document.getElementById('source-type').value = 'webhook';
      mapperInstance.updateSourceConfig('webhook');
      mapperInstance.generateWebhook();

      // Set target type to email
      document.getElementById('integration-target-type').value = 'email';
      mapperInstance.updateTargetTypeConfig('email');

      // Configure email settings
      document.getElementById('email-smtp-server').value = 'smtp.gmail.com';
      document.getElementById('email-smtp-port').value = '587';
      document.getElementById('email-smtp-username').value = 'youremail@gmail.com';
      document.getElementById('email-smtp-password').value = '<your app key>';
      document.getElementById('email-from').value = 'youremail@gmail.com';
      document.getElementById('email-to').value = 'youremail@gmail.com';
      document.getElementById('email-subject').value = 'Email Integration Test';
      document.getElementById('email-use-tls').value = 'true';

      mapperInstance.saveIntegration();

      const source = JSON.stringify({
        "orderId": "ORD-12345",
        "customer": {
          "name": "Jane Smith",
          "email": "jane@example.com"
        },
        "items": [
          {"product": "Widget", "quantity": 2, "price": 25.00}
        ],
        "total": 50.00,
        "status": "pending"
      }, null, 2);

      const target = JSON.stringify({
        "orderNumber": "",
        "customerName": "",
        "customerEmail": "",
        "totalAmount": "",
        "orderStatus": ""
      }, null, 2);

      mapperInstance.loadJsonStrings(source, target);

      setTimeout(function() {
        mapperInstance.addMapping('orderId', 'orderNumber', 'none');
        mapperInstance.addMapping('customer.name', 'customerName', 'none');
        mapperInstance.addMapping('customer.email', 'customerEmail', 'lowercase');
        mapperInstance.addMapping('', 'totalAmount', 'javascript', [],
          "return '$' + fields['total'].toFixed(2)",
          ['total']);
        mapperInstance.addMapping('status', 'orderStatus', 'uppercase');
      }, 200);
    }

    // Attach example button listeners
    document.getElementById('example1-btn').addEventListener('click', loadIntegrationExample1);
    document.getElementById('example2-btn').addEventListener('click', loadIntegrationExample2);
    document.getElementById('example3-btn').addEventListener('click', loadIntegrationExample3);

    </script>
</body>

</html>